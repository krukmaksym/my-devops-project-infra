name: Terraform PR Validation

on:
  pull_request:
    branches: [main]
    paths:
      - 'infra/terraform/**'
      - '.github/workflows/terraform-pr.yml'

permissions:
  contents: read
  pull-requests: write

env:
  TERRAFORM_VERSION: '1.14.0'
  TERRAGRUNT_VERSION: '0.55.1'

jobs:
  security-gate:
    name: Security Gate
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - name: Check if PR is from fork
        id: check
        run: |
          echo "ðŸ” Checking PR source..."
          if [ "${{ github.event.pull_request.head.repo.full_name }}" == "${{ github.repository }}" ]; then
            echo "âœ… PR is from the main repository"
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ PR is from a fork - skipping workflows for security"
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

  detect-changes:
    name: Detect Changed Modules
    runs-on: ubuntu-latest
    needs: security-gate
    if: needs.security-gate.outputs.should_run == 'true'
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_changes: ${{ steps.set-matrix.outputs.has_changes }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          files: |
            infra/terraform/live/**/*.tf
            infra/terraform/live/**/*.hcl
          json: true

      - name: Set matrix for changed modules
        id: set-matrix
        run: |
          changed_files='${{ steps.changed-files.outputs.all_changed_files }}'
          echo "Changed files: $changed_files"
          
          if [ -z "$changed_files" ] || [ "$changed_files" == "[]" ] || [ "$changed_files" == "" ]; then
            echo "No terraform files changed"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "matrix={\"include\":[]}" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "has_changes=true" >> $GITHUB_OUTPUT
          
          modules=$(echo "$changed_files" | \
            jq -r '.[]' | \
            grep -E "infra/terraform/live/(dev|stage|prod)/(network|kubernetes)" | \
            sed -E 's|infra/terraform/live/([^/]+)/([^/]+)/.*|\1 \2|' | \
            sort -u)
          
          echo "Detected modules: $modules"
          
          if [ -z "$modules" ]; then
            echo "No valid modules detected"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "matrix={\"include\":[]}" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          matrix_json=$(echo "$modules" | jq -R -s -c '
            split("\n") | 
            map(select(length > 0)) | 
            map(split(" ") | {env: .[0], module: .[1]}) | 
            {include: .}
          ')
          
          echo "Matrix JSON: $matrix_json"
          echo "matrix=$matrix_json" >> $GITHUB_OUTPUT

  terraform-format:
    name: Terraform Format Check
    runs-on: ubuntu-latest
    needs: [security-gate, detect-changes]
    if: needs.security-gate.outputs.should_run == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Format Check
        run: |
          echo "ðŸŽ¨ Checking Terraform formatting..."
          cd infra/terraform
          terraform fmt -check -recursive -diff

  terragrunt-validate:
    name: Validate (${{ matrix.env }}/${{ matrix.module }})
    runs-on: ubuntu-latest
    needs: [security-gate, detect-changes, terraform-format]
    if: needs.security-gate.outputs.should_run == 'true' && needs.detect-changes.outputs.has_changes == 'true'
    strategy:
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # USE COMPOSITE ACTION HERE
      - name: Setup Terragrunt Environment
        uses: ./.github/actions/setup-terragrunt
        with:
          terraform-version: ${{ env.TERRAFORM_VERSION }}
          terragrunt-version: ${{ env.TERRAGRUNT_VERSION }}

      # USE COMPOSITE ACTION HERE
      - name: Terragrunt Validate
        uses: ./.github/actions/terragrunt-exec
        with:
          working-directory: infra/terraform/live/${{ matrix.env }}/${{ matrix.module }}
          command: validate
          doppler-token: ${{ secrets.DOPPLER_TOKEN }}

  terragrunt-plan:
    name: Plan (${{ matrix.env }}/${{ matrix.module }})
    runs-on: ubuntu-latest
    needs: [security-gate, detect-changes, terraform-format, terragrunt-validate]
    if: needs.security-gate.outputs.should_run == 'true' && needs.detect-changes.outputs.has_changes == 'true'
    strategy:
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # USE COMPOSITE ACTION HERE
      - name: Setup Terragrunt Environment
        uses: ./.github/actions/setup-terragrunt
        with:
          terraform-version: ${{ env.TERRAFORM_VERSION }}
          terragrunt-version: ${{ env.TERRAGRUNT_VERSION }}

      # USE COMPOSITE ACTION HERE  
      - name: Terragrunt Init
        uses: ./.github/actions/terragrunt-exec
        with:
          working-directory: infra/terraform/live/${{ matrix.env }}/${{ matrix.module }}
          command: init
          doppler-token: ${{ secrets.DOPPLER_TOKEN }}

      - name: Terragrunt Plan
        id: plan
        uses: ./.github/actions/terragrunt-exec
        with:
          working-directory: infra/terraform/live/${{ matrix.env }}/${{ matrix.module }}
          command: plan
          doppler-token: ${{ secrets.DOPPLER_TOKEN }}
          extra-args: -no-color -out=tfplan

      - name: Extract Plan Summary
        id: summary
        run: |
          plan_output='${{ steps.plan.outputs.output }}'
          plan_summary=$(echo "$plan_output" | grep -E "Plan:|No changes" | tail -1 || echo "Plan completed")
          
          echo "PLAN_SUMMARY<<EOF" >> $GITHUB_OUTPUT
          echo "$plan_summary" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "PLAN_OUTPUT<<EOF" >> $GITHUB_OUTPUT
          echo "$plan_output" | tail -100 >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment PR with Plan
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        env:
          PLAN_SUMMARY: ${{ steps.summary.outputs.PLAN_SUMMARY }}
          PLAN_OUTPUT: ${{ steps.summary.outputs.PLAN_OUTPUT }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `#### Terraform Plan ðŸ“‹ \`${{ matrix.env }}/${{ matrix.module }}\`
            
            **Summary:** ${process.env.PLAN_SUMMARY}
            
            <details><summary>Show Plan Details</summary>
            
            \`\`\`terraform
            ${process.env.PLAN_OUTPUT}
            \`\`\`
            
            </details>
            
            *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`, Workflow: \`${{ github.workflow }}\`*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

  plan-summary:
    name: Plan Summary
    runs-on: ubuntu-latest
    needs: [terraform-format, terragrunt-validate, terragrunt-plan]
    if: always()
    steps:
      - name: Check Results
        run: |
          echo "## Plan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.terraform-format.result }}" != "success" ]; then
            echo "âŒ Terraform format check failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          if [ "${{ needs.terragrunt-validate.result }}" == "failure" ]; then
            echo "âŒ Terragrunt validation failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          if [ "${{ needs.terragrunt-plan.result }}" == "failure" ]; then
            echo "âŒ Terragrunt plan failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          elif [ "${{ needs.terragrunt-plan.result }}" == "skipped" ]; then
            echo "â­ï¸ No terraform changes detected" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… All plans completed successfully" >> $GITHUB_STEP_SUMMARY
          fi
