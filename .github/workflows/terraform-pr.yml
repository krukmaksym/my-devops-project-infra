name: Terraform PR Validation

on:
  pull_request:
    branches: [main]
    paths:
      - 'infra/terraform/**'
      - '.github/workflows/terraform-pr.yml'

permissions:
  contents: read
  pull-requests: write

env:
  TERRAFORM_VERSION: '1.14.0'
  TERRAGRUNT_VERSION: '0.55.1'

jobs:
  security-gate:
    name: Security Gate
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - name: Check if PR is from fork
        id: check
        run: |
          echo "üîç Checking PR source..."
          if [ "${{ github.event.pull_request.head.repo.full_name }}" == "${{ github.repository }}" ]; then
            echo "‚úÖ PR is from the main repository"
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è PR is from a fork - skipping workflows for security"
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

  detect-changes:
    name: Detect Changed Modules
    runs-on: ubuntu-latest
    needs: security-gate
    if: needs.security-gate.outputs.should_run == 'true'
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_changes: ${{ steps.set-matrix.outputs.has_changes }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          files: |
            infra/terraform/modules/**/*.tf
            infra/terraform/live/**/*.tf
            infra/terraform/live/**/*.hcl
          base_sha: ${{ github.event.pull_request.base.sha }}
          sha: ${{ github.event.pull_request.head.sha }}

      - name: Set matrix for changed modules
        id: set-matrix
        run: |
          # Use newline-separated output instead of JSON
          changed_files="${{ steps.changed-files.outputs.all_changed_files }}"

          echo "=== DEBUG: Changed files raw ==="
          echo "$changed_files"
          echo "==========================="

          if [ -z "$changed_files" ]; then
            echo "‚ùå No terraform files changed"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "matrix={\"include\":[]}" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "has_changes=true" >> $GITHUB_OUTPUT

          # Separate module changes from live changes (all_changed_files is space-separated)
          echo "=== DEBUG: Filtering for module changes ==="
          module_changes=$(echo "$changed_files" | tr ' ' '\n' | grep "infra/terraform/modules/" || true)
          echo "Module changes result: '$module_changes'"
          echo "==========================="

          echo "=== DEBUG: Filtering for live changes ==="
          live_changes=$(echo "$changed_files" | tr ' ' '\n' | grep "infra/terraform/live/" || echo "")
          echo "Live changes result: '$live_changes'"
          echo "==========================="
          
          matrix_items=""
          
          # Handle module changes - plan ALL environments for changed modules
          if [ -n "$module_changes" ]; then
            echo "üì¶ Module changes detected!"
            echo "$module_changes"
            
            # Extract which modules changed (network, kubernetes)
            echo "=== DEBUG: Extracting module names ==="
            changed_modules=$(echo "$module_changes" | \
              sed -E 's|infra/terraform/modules/([^/]+)/.*|\1|' | \
              sort -u)
            echo "Changed modules: '$changed_modules'"
            echo "==========================="
            
            # For each changed module, add all environments
            for module in $changed_modules; do
              echo "Adding module: $module to all environments"
              for env in dev stage prod; do
                matrix_items="${matrix_items}{\"env\":\"${env}\",\"module\":\"${module}\"},"
                echo "  Added: ${env}/${module}"
              done
            done
          else
            echo "‚ö†Ô∏è No module changes detected"
          fi
          
          # Handle live changes - plan only specific env/module
          if [ -n "$live_changes" ]; then
            echo "üîß Live changes detected!"
            echo "$live_changes"
            
            live_modules=$(echo "$live_changes" | \
              grep -E "infra/terraform/live/(dev|stage|prod)/(network|kubernetes)" | \
              sed -E 's|infra/terraform/live/([^/]+)/([^/]+)/.*|\1 \2|' | \
              sort -u)
            
            echo "Live modules: '$live_modules'"
            
            # Add to matrix
            while IFS= read -r item; do
              if [ -n "$item" ]; then
                env=$(echo "$item" | awk '{print $1}')
                module=$(echo "$item" | awk '{print $2}')
                matrix_items="${matrix_items}{\"env\":\"${env}\",\"module\":\"${module}\"},"
                echo "  Added: ${env}/${module}"
              fi
            done <<< "$live_modules"
          else
            echo "‚ö†Ô∏è No live changes detected"
          fi
          
          echo "=== DEBUG: Matrix items before cleanup ==="
          echo "Matrix items: '$matrix_items'"
          echo "==========================="
          
          # Remove trailing comma
          matrix_items="${matrix_items%,}"
          
          if [ -z "$matrix_items" ]; then
            echo "‚ùå No valid changes detected after parsing"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "matrix={\"include\":[]}" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "=== DEBUG: Creating final JSON ==="
          matrix_json=$(echo "{\"include\":[${matrix_items}]}" | \
            jq -c '.include | unique | {include: .}')

          echo "‚úÖ Final Matrix JSON: $matrix_json"
          echo "matrix<<EOF" >> $GITHUB_OUTPUT
          echo "$matrix_json" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  terraform-format:
    name: Terraform Format Check
    runs-on: ubuntu-latest
    needs: [security-gate, detect-changes]
    if: needs.security-gate.outputs.should_run == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Format Check
        run: |
          echo "üé® Checking Terraform formatting..."
          cd infra/terraform
          terraform fmt -check -recursive -diff

  terragrunt-validate:
    name: Validate (${{ matrix.env }}/${{ matrix.module }})
    runs-on: ubuntu-latest
    needs: [security-gate, detect-changes, terraform-format]
    if: needs.security-gate.outputs.should_run == 'true' && needs.detect-changes.outputs.has_changes == 'true'
    strategy:
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # USE COMPOSITE ACTION HERE
      - name: Setup Terragrunt Environment
        uses: ./.github/actions/setup-terragrunt
        with:
          terraform-version: ${{ env.TERRAFORM_VERSION }}
          terragrunt-version: ${{ env.TERRAGRUNT_VERSION }}

      # USE COMPOSITE ACTION HERE
      - name: Terragrunt Validate
        uses: ./.github/actions/terragrunt-exec
        with:
          working-directory: infra/terraform/live/${{ matrix.env }}/${{ matrix.module }}
          command: validate
          doppler-token: ${{ secrets.DOPPLER_TOKEN }}

  terragrunt-plan:
    name: Plan (${{ matrix.env }}/${{ matrix.module }})
    runs-on: ubuntu-latest
    needs: [security-gate, detect-changes, terraform-format, terragrunt-validate]
    if: needs.security-gate.outputs.should_run == 'true' && needs.detect-changes.outputs.has_changes == 'true'
    strategy:
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # USE COMPOSITE ACTION HERE
      - name: Setup Terragrunt Environment
        uses: ./.github/actions/setup-terragrunt
        with:
          terraform-version: ${{ env.TERRAFORM_VERSION }}
          terragrunt-version: ${{ env.TERRAGRUNT_VERSION }}

      # USE COMPOSITE ACTION HERE  
      - name: Terragrunt Init
        uses: ./.github/actions/terragrunt-exec
        with:
          working-directory: infra/terraform/live/${{ matrix.env }}/${{ matrix.module }}
          command: init
          doppler-token: ${{ secrets.DOPPLER_TOKEN }}

      - name: Terragrunt Plan
        id: plan
        uses: ./.github/actions/terragrunt-exec
        with:
          working-directory: infra/terraform/live/${{ matrix.env }}/${{ matrix.module }}
          command: plan
          doppler-token: ${{ secrets.DOPPLER_TOKEN }}
          extra-args: -no-color -out=tfplan

      - name: Extract Plan Summary
        id: summary
        run: |
          plan_output='${{ steps.plan.outputs.output }}'
          plan_summary=$(echo "$plan_output" | grep -E "Plan:|No changes" | tail -1 || echo "Plan completed")
          
          echo "PLAN_SUMMARY<<EOF" >> $GITHUB_OUTPUT
          echo "$plan_summary" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "PLAN_OUTPUT<<EOF" >> $GITHUB_OUTPUT
          echo "$plan_output" | tail -100 >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment PR with Plan
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        env:
          PLAN_SUMMARY: ${{ steps.summary.outputs.PLAN_SUMMARY }}
          PLAN_OUTPUT: ${{ steps.summary.outputs.PLAN_OUTPUT }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `#### Terraform Plan üìã \`${{ matrix.env }}/${{ matrix.module }}\`
            
            **Summary:** ${process.env.PLAN_SUMMARY}
            
            <details><summary>Show Plan Details</summary>
            
            \`\`\`terraform
            ${process.env.PLAN_OUTPUT}
            \`\`\`
            
            </details>
            
            *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`, Workflow: \`${{ github.workflow }}\`*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

  plan-summary:
    name: Plan Summary
    runs-on: ubuntu-latest
    needs: [terraform-format, terragrunt-validate, terragrunt-plan]
    if: always()
    steps:
      - name: Check Results
        run: |
          echo "## Plan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.terraform-format.result }}" != "success" ]; then
            echo "‚ùå Terraform format check failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          if [ "${{ needs.terragrunt-validate.result }}" == "failure" ]; then
            echo "‚ùå Terragrunt validation failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          if [ "${{ needs.terragrunt-plan.result }}" == "failure" ]; then
            echo "‚ùå Terragrunt plan failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          elif [ "${{ needs.terragrunt-plan.result }}" == "skipped" ]; then
            echo "‚è≠Ô∏è No terraform changes detected" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ All plans completed successfully" >> $GITHUB_STEP_SUMMARY
          fi
