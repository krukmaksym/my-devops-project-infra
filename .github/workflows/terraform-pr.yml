name: Terraform PR Validation

on:
  pull_request:
    branches: [main]
    paths:
      - 'infra/terraform/**'
      - '.github/workflows/terraform-pr.yml'

permissions:
  contents: read
  pull-requests: write

env:
  TERRAFORM_VERSION: '1.14.0'
  TERRAGRUNT_VERSION: '0.55.1'

jobs:
  security-gate:
    name: Security Gate
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - name: Check if PR is from fork
        id: check
        run: |
          echo "ðŸ” Checking PR source..."
          if [ "${{ github.event.pull_request.head.repo.full_name }}" == "${{ github.repository }}" ]; then
            echo "âœ… PR is from the main repository"
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ PR is from a fork - skipping workflows for security"
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

  detect-changes:
    name: Detect Changed Modules
    runs-on: ubuntu-latest
    needs: security-gate
    if: needs.security-gate.outputs.should_run == 'true'
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_changes: ${{ steps.set-matrix.outputs.has_changes }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          files: |
            infra/terraform/live/**/*.tf
            infra/terraform/live/**/*.hcl
          json: true

      - name: Set matrix for changed modules
        id: set-matrix
        run: |
          # Get the changed files
          changed_files='${{ steps.changed-files.outputs.all_changed_files }}'
          
          echo "Changed files: $changed_files"
          
          # Check if any files changed
          if [ -z "$changed_files" ] || [ "$changed_files" == "[]" ] || [ "$changed_files" == "" ]; then
            echo "No terraform files changed"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "matrix={\"include\":[]}" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "has_changes=true" >> $GITHUB_OUTPUT
          
          # Extract unique env/module combinations
          # Input: infra/terraform/live/dev/network/main.tf
          # Output: dev network
          modules=$(echo "$changed_files" | \
            jq -r '.[]' | \
            grep -E "infra/terraform/live/(dev|stage|prod)/(network|kubernetes)" | \
            sed -E 's|infra/terraform/live/([^/]+)/([^/]+)/.*|\1 \2|' | \
            sort -u)
          
          echo "Detected modules:"
          echo "$modules"
          
          # Build JSON array
          if [ -z "$modules" ]; then
            echo "No valid modules detected"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "matrix={\"include\":[]}" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Convert to JSON format
          matrix_json=$(echo "$modules" | jq -R -s -c '
            split("\n") | 
            map(select(length > 0)) | 
            map(split(" ") | {env: .[0], module: .[1]}) | 
            {include: .}
          ')
          
          echo "Matrix JSON: $matrix_json"
          echo "matrix=$matrix_json" >> $GITHUB_OUTPUT

  terraform-format:
    name: Terraform Format Check
    runs-on: ubuntu-latest
    needs: [security-gate, detect-changes]
    if: needs.security-gate.outputs.should_run == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Format Check
        run: |
          echo "ðŸŽ¨ Checking Terraform formatting..."
          cd infra/terraform
          terraform fmt -check -recursive -diff

      - name: Terragrunt Format Check
        run: |
          echo "ðŸŽ¨ Checking Terragrunt formatting..."
          find infra/terraform/live -name "*.hcl" -type f | while read file; do
            echo "Checking $file"
            # Basic HCL syntax check
            cat "$file" > /dev/null || exit 1
          done
          echo "âœ… All HCL files are valid"

  terragrunt-validate:
    name: Validate (${{ matrix.env }}/${{ matrix.module }})
    runs-on: ubuntu-latest
    needs: [security-gate, detect-changes, terraform-format]
    if: needs.security-gate.outputs.should_run == 'true' && needs.detect-changes.outputs.has_changes == 'true'
    strategy:
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Install Terragrunt
        run: |
          echo "ðŸ“¦ Installing Terragrunt..."
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TERRAGRUNT_VERSION }}/terragrunt_linux_amd64
          chmod +x terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt
          terragrunt --version

      - name: Install Doppler CLI
        run: |
          echo "ðŸ” Installing Doppler CLI..."
          curl -Ls https://cli.doppler.com/install.sh | sh
          doppler --version

      - name: Terragrunt Validate
        working-directory: infra/terraform/live/${{ matrix.env }}/${{ matrix.module }}
        env:
          DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN }}
        run: |
          echo "âœ… Validating ${{ matrix.env }}/${{ matrix.module }} via Terragrunt..."
          doppler run --name-transformer tf-var -- terragrunt validate

  terragrunt-plan:
    name: Plan (${{ matrix.env }}/${{ matrix.module }})
    runs-on: ubuntu-latest
    needs: [security-gate, detect-changes, terraform-format, terragrunt-validate]
    if: needs.security-gate.outputs.should_run == 'true' && needs.detect-changes.outputs.has_changes == 'true'
    strategy:
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Install Terragrunt
        run: |
          echo "ðŸ“¦ Installing Terragrunt..."
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TERRAGRUNT_VERSION }}/terragrunt_linux_amd64
          chmod +x terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt
          terragrunt --version

      - name: Install Doppler CLI
        run: |
          echo "ðŸ” Installing Doppler CLI..."
          curl -Ls https://cli.doppler.com/install.sh | sh
          doppler --version

      - name: Configure Doppler
        env:
          DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN }}
        run: |
          doppler configure set token $DOPPLER_TOKEN

      - name: Terragrunt Init
        working-directory: infra/terraform/live/${{ matrix.env }}/${{ matrix.module }}
        env:
          DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN }}
        run: |
          echo "ðŸ”§ Initializing Terragrunt for ${{ matrix.env }}/${{ matrix.module }}..."
          doppler run --name-transformer tf-var -- terragrunt init

      - name: Terragrunt Plan
        id: plan
        working-directory: infra/terraform/live/${{ matrix.env }}/${{ matrix.module }}
        env:
          DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN }}
        run: |
          echo "ðŸ“‹ Running Terragrunt plan for ${{ matrix.env }}/${{ matrix.module }}..."
          
          # Run plan and capture output
          doppler run --name-transformer tf-var -- terragrunt plan -no-color -out=tfplan 2>&1 | tee plan_output.txt
          
          # Extract plan summary
          plan_summary=$(grep -E "Plan:|No changes" plan_output.txt | tail -1 || echo "Plan completed")
          
          # Save for PR comment
          echo "PLAN_SUMMARY<<EOF" >> $GITHUB_OUTPUT
          echo "$plan_summary" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Save full output (truncated to avoid huge comments)
          echo "PLAN_OUTPUT<<EOF" >> $GITHUB_OUTPUT
          tail -100 plan_output.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment PR with Plan
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        env:
          PLAN_SUMMARY: ${{ steps.plan.outputs.PLAN_SUMMARY }}
          PLAN_OUTPUT: ${{ steps.plan.outputs.PLAN_OUTPUT }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `#### Terraform Plan ðŸ“‹ \`${{ matrix.env }}/${{ matrix.module }}\`
            
            **Summary:** ${process.env.PLAN_SUMMARY}
            
            <details><summary>Show Plan Details</summary>
            
            \`\`\`terraform
            ${process.env.PLAN_OUTPUT}
            \`\`\`
            
            </details>
            
            *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`, Workflow: \`${{ github.workflow }}\`*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

  plan-summary:
    name: Plan Summary
    runs-on: ubuntu-latest
    needs: [terraform-format, terragrunt-validate, terragrunt-plan]
    if: always()
    steps:
      - name: Check Results
        run: |
          echo "## Plan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.terraform-format.result }}" != "success" ]; then
            echo "âŒ Terraform format check failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          if [ "${{ needs.terragrunt-validate.result }}" == "failure" ]; then
            echo "âŒ Terragrunt validation failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          if [ "${{ needs.terragrunt-plan.result }}" == "failure" ]; then
            echo "âŒ Terragrunt plan failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          elif [ "${{ needs.terragrunt-plan.result }}" == "skipped" ]; then
            echo "â­ï¸ No terraform changes detected" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… All plans completed successfully" >> $GITHUB_STEP_SUMMARY
          fi